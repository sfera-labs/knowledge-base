# Watching sysfs files for changes

**sysfs** files are *virtual* files whose content is dynamically generated when read. You cannot generally "watch" sysfs files for content changes as there is, in fact, no content.

The kernel module generating the content for the sysfs file can nevertheless notify user space applications when changes (or other events) occur.

User space applications can use the [poll](https://man7.org/linux/man-pages/man2/poll.2.html) system call to wait for these events, instead of consuming resources on infinite loops that continuously read the file to catch changes.

For instance, GPIO sysfs files are not "pollable" by default, but you can enable notifications from the underlying kernel module by writing to the `edge` file of the GPIO of interest, specifying the edge you want to get notifications for: "none", "rising", "falling", or "both".

Example:
```
echo 4 > /sys/class/gpio/export
echo in > /sys/class/gpio/gpio4/direction
echo rising > /sys/class/gpio/gpio4/edge
```

You can now poll the `/sys/class/gpio/gpio4/value` file to wait for notifications of GPIO4 rising.

Some of the files generated by [the kernel modules for Sfera Labs' Pi-based boards and modules](https://github.com/orgs/sfera-labs/repositories?q=kernel-module) provide for changes notifications, for instance, [the sysfs files reporting the debounced value of Iono Pi's digital inputs](https://github.com/sfera-labs/iono-pi-kernel-module#digital-inputs---sysclassionopidigital_in).

To enable notifications for a "pollable" sysfs file, read it once first, then call poll to wait for notifications.

The following examples show you how to implement the polling in different programming languages. Here we watch DI6 of Iono Pi for (debounced) state changes:

### C
```C
#include <stdio.h>
#include <fcntl.h>
#include <unistd.h>
#include <poll.h>

int main(int argc, char *argv[]) {
    int fd;
    struct pollfd pfd;
    char buf[8];

    fd = open("/sys/class/ionopi/digital_in/di6_deb", O_RDONLY);
    pfd.fd = fd;
    pfd.events = POLLPRI;

    read(fd, buf, sizeof(buf));

    while (1) {
        poll(&pfd, 1, -1);
        printf("event!\n");

        // consume event
        lseek(fd, 0, SEEK_SET);
        read(fd, buf, sizeof(buf));
    }
}
```

### Python
```Python
from select import poll, POLLPRI

file = open("/sys/class/ionopi/digital_in/di6_deb", "r")

p = poll()
p.register(file.fileno(), POLLPRI)

file.read()

while True:
    p.poll()
    print("event!")

    # consume event
    file.seek(0)
    file.read()
```

### Java
```Java
import java.nio.file.FileSystems;
import java.nio.file.Files;
import java.nio.file.Path;
import java.nio.file.Paths;
import java.nio.file.WatchEvent;
import java.nio.file.WatchKey;
import java.nio.file.WatchService;
import static java.nio.file.StandardWatchEventKinds.ENTRY_MODIFY;

public class Main {

    public static void main(String[] args) throws Exception {
        WatchService ws = FileSystems.getDefault().newWatchService();
        Path p = Paths.get("/sys/class/ionopi/digital_in/di6_deb");
        Files.readAllBytes(p);
        Path parentDir = p.getParent();
        parentDir.register(ws, ENTRY_MODIFY);
        while (true) {
            WatchKey wk = ws.take();
            for (WatchEvent<?> event : wk.pollEvents()) {
                Path changed = (Path) event.context();
                if (p.endsWith(changed)) {
                    System.out.println("event!");
                }
            }
            wk.reset();
        }
    }
}
```
